{% extends "base.html" %}

{% load static %}

{% block css %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'favorites/css/fav.css' %}">

<style>
        body {
            background-image: url('{% static "cart/img/cart.jpg" %}');
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
        }
</style>
{% endblock %}

{% block title %}Корзина - Denny Rose{% endblock %}

{% block content %}
<table style=" z-index: 20; width: 100vw; position: relative; height: 5vh; margin: 1vh;">
        <thead>
            <tr style="justify-content: center; display: flex;">
                <th scope="col" class="page_name">Избранные товары</th>
            </tr>
        </thead>
    </table>
<div class="favorites-container">
    <table class="favorites-table">
        {% for item in favorites %}
        <tr>
            <td>
                <a href="#" class="remove-favorite" data-id="{{ item.id }}">
                    <img src="{% static 'main/img/red_heart.png' %}" alt="Удалить из Избранного">
                </a>
            </td>
            <td>{{ item.product.name }}</td>
            <td>{{ item.product.price }} руб.</td>
            <td>
                <form action="{{ host }}/catalog/{{ item.product.subcategory.name }}/products/{{ item.product.id }}/">
                    <button type="submit" class="btn btn-outline-danger">Перейти к товару</button>
                </form>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="4" style="text-align: center;">Список избранных товаров пуст</td>
        </tr>
        {% endfor %}
    </table>
</div>

<div id="deleteModal" class="modal">
    <div class="modal-content">
        <p>Вы точно хотите удалить этот товар из Избранного?</p>
        <div class="modal-buttons">
            <button id="confirmDelete">Да</button>
            <button id="cancelDelete">Нет</button>
        </div>
    </div>
</div>

<!-- Скрытый элемент для хранения URL -->
<input type="hidden" id="remove-favorite-url" value="{% url 'remove_favorite' 0 %}">
{% endblock %}

{% block js %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('deleteModal');
            const confirmButton = document.getElementById('confirmDelete');
            const cancelButton = document.getElementById('cancelDelete');
            let favoriteIdToRemove;

            // Получаем базовый URL из скрытого элемента
            const removeFavoriteUrl = document.getElementById('remove-favorite-url').value;

            // Открытие модального окна
            document.querySelectorAll('.remove-favorite').forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    favoriteIdToRemove = this.dataset.id;
                    modal.style.display = 'flex';
                });
            });

            // Закрытие модального окна по кнопке "Нет"
            cancelButton.addEventListener('click', function () {
                modal.style.display = 'none';
            });

            // Удаление товара из Избранного
            confirmButton.addEventListener('click', function () {
                if (favoriteIdToRemove) {
                    // Заменяем placeholder (0) на реальный ID товара
                    const url = removeFavoriteUrl.replace('0', favoriteIdToRemove);

                    fetch(url, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                        },
                    })
                        .then(response => {
                            if (response.ok) {
                                window.location.reload(); // Перезагрузка страницы после удаления
                            }
                        })
                        .catch(error => console.error('Ошибка:', error));
                }
                modal.style.display = 'none';
            });
        });
    </script>
{% endblock %}