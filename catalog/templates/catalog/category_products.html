{% extends "base.html" %}

{% load static %}

{% block css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
        <link rel="stylesheet" href="{% static 'catalog/css/products.css' %}">
    {% endblock %}

{% block title %}{{ current_subcategory.name }} - Denny Rose{% endblock %}

{% block content %}
<style>
    body{
        background: url('{% static 'authorization/img/auth.jpg' %}') no-repeat center center/cover;
    }
</style>

<div class="filter-container">
    <h1 style=" position: absolute; top: 10%; left: 10%;">{{ current_subcategory.name }}</h1>
    <div class="filter-row">
        <!-- Поле для ввода цены -->
        <div class="filter-item price-filter">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#priceFilter" style="background: none;">
                Цена
            </button>
            <div id="priceFilter" class="accordion-collapse collapse" data-bs-parent="#filtersAccordion">
                <div class="accordion-body">
                    <div class="price-inputs">
                        <div class="price-input">
                            <label for="minPrice">От</label>
                            <input type="number" id="minPrice" placeholder="Min" min="{{ min_price }}" max="{{ max_price }}" style="width: 100%;">
                        </div>
                        <div class="price-input">
                            <label for="maxPrice">До</label>
                            <input type="number" id="maxPrice" placeholder="Max" min="{{ min_price }}" max="{{ max_price }}" style="width: 100%;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Фильтр по размерам -->
        <div class="filter-item">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sizeFilter" style="background: none;">
                Размер
            </button>
            <div id="sizeFilter" class="accordion-collapse collapse" data-bs-parent="#filtersAccordion">
                <div class="accordion-body">
                    {% for size in sizes %}
                        <div class="form-check">
                            <input class="form-check-input size-checkbox" type="checkbox" value="{{ size }}" name="sizes" id="size-{{ size }}">
                            <label class="form-check-label" for="size-{{ size }}">{{ size }}</label>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Фильтр по цветам -->
        <div class="filter-item">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#colorFilter" style="background: none;">
                Цвет
            </button>
            <div id="colorFilter" class="accordion-collapse collapse" data-bs-parent="#filtersAccordion">
                <div class="accordion-body">
                    {% for color in colors %}
                        <div class="form-check">
                            <input class="form-check-input color-checkbox" type="checkbox" value="{{ color }}" id="color-{{ color }}">
                            <label class="form-check-label" for="color-{{ color }}">{{ color }}</label>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Кнопка "Применить" -->
        <div class="filter-item">
            <button class="btn btn-primary apply-filters">Применить</button>
        </div>
    </div>
</div>

<!-- Список товаров -->
<div class="wrapper">
    <div class="product-grid">
        {% for product in products %}
            <div class="product-card" data-product-id="{{ product.id }}">
                <img src="{{ product.image_url }}" alt="{{ product.name }}">
                <div class="product-title-container">
                    <div class="product-name">{{ product.name }}</div>
                </div>
                <div class="product-price">{{ product.price }} руб.</div>
                <div class="quantity-control initial">
                    <a href="{% url 'product_detail' subcategory_name=current_subcategory.name product_id=product.id %}">
                        <button type="button" class="btn btn-warning btn-product">К товару</button>
                    </a>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

{% endblock %}

{% block js %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
    <script src="{% static 'catalog/js/products.js' %}"></script>
    <script>
document.addEventListener('DOMContentLoaded', function () {
    const applyFiltersButton = document.querySelector('.apply-filters');
    const sizeCheckboxes = document.querySelectorAll('.size-checkbox');
    const colorCheckboxes = document.querySelectorAll('.color-checkbox');
    const minPriceInput = document.getElementById('minPrice');
    const maxPriceInput = document.getElementById('maxPrice');

    // Функция для сохранения данных в cookies
    function saveToCookies(name, value) {
        document.cookie = `${name}=${encodeURIComponent(value)}; path=/; max-age=31536000`; // max-age = 1 год
    }

    // Функция для загрузки данных из cookies
    function loadFromCookies(name) {
        const cookies = document.cookie.split('; ').reduce((acc, cookie) => {
            const [key, value] = cookie.split('=');
            acc[key] = decodeURIComponent(value);
            return acc;
        }, {});
        return cookies[name] || '';
    }

    // Загружаем сохраненные данные из cookies
    const savedSizes = loadFromCookies('selected_sizes').split(',');
    const savedColors = loadFromCookies('selected_colors').split(',');
    const savedMinPrice = loadFromCookies('min_price');
    const savedMaxPrice = loadFromCookies('max_price');

    // Устанавливаем состояние чекбоксов на основе сохраненных данных
    sizeCheckboxes.forEach(checkbox => {
        if (savedSizes.includes(checkbox.value)) {
            checkbox.checked = true;
        }
    });

    colorCheckboxes.forEach(checkbox => {
        if (savedColors.includes(checkbox.value)) {
            checkbox.checked = true;
        }
    });

    minPriceInput.value = savedMinPrice;
    maxPriceInput.value = savedMaxPrice;

    // Обработчик кнопки "Применить"
    applyFiltersButton.addEventListener('click', function () {
        // Собираем выбранные размеры и цвета
        const selectedSizes = Array.from(document.querySelectorAll('.size-checkbox:checked')).map(checkbox => checkbox.value);
        const selectedColors = Array.from(document.querySelectorAll('.color-checkbox:checked')).map(checkbox => checkbox.value);

        // Собираем значения цен
        let minPriceValue = minPriceInput.value;
        let maxPriceValue = maxPriceInput.value;

        // Проверка корректности введенных значений
        const minPriceLimit = {{ min_price }};
        const maxPriceLimit = {{ max_price }};

        if (minPriceValue && maxPriceValue) {
            if (parseFloat(minPriceValue) < minPriceLimit || parseFloat(maxPriceValue) > maxPriceLimit) {
                alert(`Цены должны быть в диапазоне от ${minPriceLimit} до ${maxPriceLimit}.`);
                return;
            }
            if (parseFloat(minPriceValue) > parseFloat(maxPriceValue)) {
                alert("Минимальная цена не может быть больше максимальной.");
                return;
            }
        }

        if (minPriceValue == 0 && maxPriceValue == 0) {
            minPriceValue = minPriceLimit;
            maxPriceValue = maxPriceLimit;
        }

        if (minPriceValue == 0 || maxPriceValue == 0) {
             alert("Введены не все данные");
             return;
        }

        // Если ничего не выбрано, отправляем пустые данные
        if (selectedSizes.length === 0 && selectedColors.length === 0 && !minPriceValue && !maxPriceValue) {
            saveToCookies('selected_sizes', '');
            saveToCookies('selected_colors', '');
            saveToCookies('min_price', '');
            saveToCookies('max_price', '');

            const subcategoryName = "{{ current_subcategory.name }}";
            const filteredUrl = `{% url 'filtered_products_view' subcategory_name="SUBCATEGORY_NAME" %}`.replace("SUBCATEGORY_NAME", subcategoryName);

            window.location.href = `${filteredUrl}`;
            return;
        }

        // Сохраняем выбранные значения в cookies
        saveToCookies('selected_sizes', selectedSizes.join(','));
        saveToCookies('selected_colors', selectedColors.join(','));
        saveToCookies('min_price', minPriceValue);
        saveToCookies('max_price', maxPriceValue);

        // Формируем URL с параметрами фильтрации
        const queryParams = new URLSearchParams({
            sizes: selectedSizes,
            colors: selectedColors,
            min_price: minPriceValue,
            max_price: maxPriceValue,
        });

        // Генерируем URL с помощью Django шаблонизатора
        const subcategoryName = "{{ current_subcategory.name }}";
        const filteredUrl = `{% url 'filtered_products_view' subcategory_name="SUBCATEGORY_NAME" %}`.replace("SUBCATEGORY_NAME", subcategoryName);

        // Перенаправляем пользователя на страницу с фильтром
        window.location.href = `${filteredUrl}?${queryParams.toString()}`;
    });
});
</script>
{% endblock %}
