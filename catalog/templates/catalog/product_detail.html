{% extends "base.html" %}

{% load static %}

{% block css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
<link rel="stylesheet" href="{% static 'catalog/css/product.css' %}">
{% endblock %}

{% block title %}Товар - Denny Rose{% endblock %}

{% block content %}

<style>
    body{
        background: url('{% static 'authorization/img/auth.jpg' %}') no-repeat center center/cover;
    }
</style>

<div class="product-detail">
    <div class="row">
        <div class="col-md-6 d-flex align-items-center">
            <div class="product-image">
                <img src="{{ product.image_url }}" alt="{{ product.name }}">
            </div>
        </div>
        <div class="col-md-6 d-flex align-items-center">
            <div class="card text-center">
                  <div class="card-header"> {{ subcategory_name }} </div>
                  <div class="card-body">
                        <a href="#" class="remove-favorite" data-url="{% url 'toggle_favorite' subcategory_name=product.subcategory.name product_id=product.id %}">
                            {% if isFavorite %}
                                <img src="{% static 'main/img/red_heart.png' %}" alt="Remove from Favorites">
                            {% else %}
                                <img src="{% static 'main/img/heart.png' %}" alt="Add to Favorites">
                            {% endif %}
                        </a>
                        <h5 class="card-title">{{ product.name }}</h5>
                        <p class="card-text">{{ product.description }}</p>
                        <p class="card-text">{{ product.price }} руб.</p>

                        <!-- Цвета товара -->
                        <div class="colors">
                            <label>Цвета:</label>
                            {% for color in colors %}
                                <div class="color-option">
                                    <input type="radio" id="color-{{ color }}" name="color" value="{{ color }}">
                                    <label for="color-{{ color }}">{{ color }}</label>
                                </div>
                            {% endfor %}
                        </div>

                        <!-- Размеры товара -->
                        <div class="sizes">
                            <label>Размеры:</label>
                            {% for size in sizes %}
                                <div class="size-option">
                                    <input type="radio" id="size-{{ size }}" name="size" value="{{ size }}">
                                    <label for="size-{{ size }}">{{ size }}</label>
                                </div>
                            {% endfor %}
                        </div>

                        <!-- Блок управления количеством -->
                        <div class="quantity-control initial">
                                <button type="submit" class="btn btn-success btn-plus">Добавить в корзину</button>
                            <div class="count">0</div>
                            <button type="button" class="btn btn-danger btn-minus">-</button>
                        </div>

                        <!-- Скрытые поля для отправки данных -->
                        {% if subcategory_name %}
                            <form id="cart-form" method="POST" action="{% url 'product_detail' subcategory_name=subcategory_name product_id=product.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="size" id="cart-selected-size" value="">
                                <input type="hidden" name="color" id="cart-selected-color" value="">
                                <input type="hidden" name="quantity" id="cart-selected-quantity" value="0">
                                <button type="submit" class="btn btn-warning md-3 add-to-cart-btn">Добавить в корзину</button>
                            </form>
                            <button class="btn btn-danger md-3 delete-btn">Убрать все товары</button>
                        {% else %}
                            <p>Error: Subcategory name is missing.</p>
                        {% endif %}

                        {% if review %}
                            <button class="btn btn-primary" style="margin-top: 1vw;" data-bs-toggle="modal" data-bs-target="#reviewModal">
                                Отзыв
                            </button>
                        {% endif %}
                  </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для редактирования отзыва -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reviewModalLabel">Оставить отзыв</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Поле для текста отзыва -->
                <textarea id="reviewDescription" class="form-control mb-3" placeholder="Введите ваш отзыв">{{ review.description|default_if_none:"" }}</textarea>

                <!-- Рейтинг (звезды) -->
                <div class="rating-area">
                    <input type="radio" id="star-5" name="rating" value="5" {% if review.stars == 5 %}checked{% endif %}>
                    <label for="star-5" title="Оценка «5»"></label>
                    <input type="radio" id="star-4" name="rating" value="4" {% if review.stars == 4 %}checked{% endif %}>
                    <label for="star-4" title="Оценка «4»"></label>
                    <input type="radio" id="star-3" name="rating" value="3" {% if review.stars == 3 %}checked{% endif %}>
                    <label for="star-3" title="Оценка «3»"></label>
                    <input type="radio" id="star-2" name="rating" value="2" {% if review.stars == 2 %}checked{% endif %}>
                    <label for="star-2" title="Оценка «2»"></label>
                    <input type="radio" id="star-1" name="rating" value="1" {% if review.stars == 1 %}checked{% endif %}>
                    <label for="star-1" title="Оценка «1»"></label>
                </div>
            </div>
            <div class="modal-footer">
                <form action="{% url 'change_review' subcategory_name=subcategory_name product_id=product.id %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" id="star" name="star" value="{{ review.stars }}">
                    <input type="hidden" id="description" name="description" value="{{ review.description|default_if_none:"" }}">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary" id="saveReviewButton" disabled>Сохранить</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="inventory-data" data-inventory="{{ inventory_data|safe|escapejs }}"></div>

<!-- Контейнер для уведомлений -->
<div id="notification-container"></div>
{% endblock %}


{% block js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'catalog/js/addGoods.js' %}"></script>
<script src="{% static 'catalog/js/product.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.remove-favorite').forEach(link => {
        link.addEventListener('click', function (e) {
            e.preventDefault();
            const url = this.dataset.url; // Получаем URL из data-url
            console.log(url);

            // Отправляем AJAX-запрос
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}', // CSRF-токен
                },
                body: JSON.stringify({ product_id: this.dataset.id }),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сети или сервера.');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'added') {
                        // Обновляем иконку на красное сердце
                        this.querySelector('img').src = "{% static 'main/img/red_heart.png' %}";
                        showNotification('success', data.message); // Уведомление
                    } else if (data.status === 'removed') {
                        // Обновляем иконку на обычное сердце
                        this.querySelector('img').src = "{% static 'main/img/heart.png' %}";
                        showNotification('warning', data.message); // Уведомление
                    } else {
                        showNotification('danger', data.message); // Ошибка
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    showNotification('danger', 'Произошла ошибка при обработке запроса.');
                });
        });
    });
});


function showNotification(type, message) {
    const notificationContainer = document.getElementById('notification-container');
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade-in`;
    notification.role = 'alert';
    notification.innerHTML = `
        ${message}
    `;
    notificationContainer.appendChild(notification);

    // Удаляем уведомление через 3 секунды
    setTimeout(() => {
        notification.classList.remove('fade-in'); // Убираем класс для запуска исчезновения
        notification.classList.add('fade-out'); // Добавляем класс для анимации исчезновения

        // Удаляем элемент после завершения анимации
        notification.addEventListener('animationend', () => {
            notification.remove();
        });
    }, 3000); // 3 секунды
}
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
    // Получаем элементы формы
    const starInput = document.getElementById('star');
    const descriptionInput = document.getElementById('description');
    const saveButton = document.getElementById('saveReviewButton');
    const reviewDescription = document.getElementById('reviewDescription');

    // Функция для проверки, нужно ли активировать кнопку "Сохранить"
    function updateSaveButtonState() {
        const hasStar = starInput.value.trim() !== '';
        const hasDescription = descriptionInput.value.trim() !== '';
        saveButton.disabled = !(hasStar || hasDescription);
    }

    // Обработчик изменения рейтинга (звезд)
    document.querySelectorAll('input[name="rating"]').forEach(radio => {
        radio.addEventListener('change', function () {
            starInput.value = this.value; // Обновляем значение скрытого поля для звезд
            updateSaveButtonState(); // Проверяем состояние кнопки
        });
    });

    // Обработчик изменения текста отзыва
    reviewDescription.addEventListener('input', function () {
        descriptionInput.value = this.value; // Обновляем значение скрытого поля для описания
        updateSaveButtonState(); // Проверяем состояние кнопки
    });
});

document.addEventListener('DOMContentLoaded', function () {
    const reviewModal = document.getElementById('reviewModal');
    const saveReviewButton = document.getElementById('saveReviewButton');

    // Обработчик закрытия модального окна
    reviewModal.addEventListener('hidden.bs.modal', function () {
        // Проверяем, была ли форма отправлена (например, через флаг)
        if (window.reviewFormSubmitted) {
            // Показываем уведомление
            showNotification('success', 'Отзыв успешно сохранен.');
            // Сбрасываем флаг
            window.reviewFormSubmitted = false;
        }
    });

    // Обработчик отправки формы
    if (saveReviewButton) {
        saveReviewButton.addEventListener('click', function () {
            // Устанавливаем флаг, что форма отправлена
            window.reviewFormSubmitted = true;
        });
    }
});
</script>
    {% endblock %}
