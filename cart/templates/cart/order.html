{% extends "base.html" %}

{% load static %}

{% block css %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'cart/css/order.css' %}">
{% endblock %}

{% block title %}Заказ - Denny Rose{% endblock %}

{% block content %}
    <div class="checkout-container">
        <!-- Левая часть: форма заказа -->
        <div class="checkout-form">
            <h2>Оформление заказа</h2>

            <!-- Выбор способа оплаты -->
            <div class="mb-3">
                <label class="form-label">Способы оплаты:</label>
                <select class="form-select" id="paymentMethod">
                    <option value="cash">Наличными (при получении)</option>
                    <option value="card">Банковской картой</option>
                </select>
            </div>

            <!-- Контейнер для оплаты картой -->
            <div id="cardPayment" style="display: none;">
                <!-- Выбор существующей карты -->
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="selectedCard" placeholder="Выберите карту" readonly>
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">Выбрать</button>
                    <ul class="dropdown-menu" id="cardList">
                        {% for card in cards %}
                            <li>
                                <a class="dropdown-item" href="#" data-number="•••• {{ card.number|slice:'-4:' }}">
                                    •••• {{ card.number|slice:'-4:' }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Ввод CVV для выбранной карты -->
                <div class="mb-3">
                    <label class="form-label">CVV</label>
                    <input type="password" class="form-control" id="cvvInput" placeholder="Введите CVV" maxlength="3" required disabled>
                    <div class="invalid-feedback">
                        Пожалуйста, выберите карту перед вводом CVV.
                    </div>
                </div>

                <!-- Добавление новой карты -->
                <div>
                    <p>Добавить новую карту <button id="addCardButton" class="btn btn-success" style="--bs-btn-padding-y: 0.2rem;">+</button></p>
                </div>
            </div>

            <!-- Pop-up окно для ввода данных новой карты -->
            <div class="popup-overlay" id="newCardPopupOverlay" style="display: none;"></div>
            <div class="popup" id="newCardPopup" style="display: none;">
                <h5>Добавить новую карту</h5>
                <form id="newCardForm">
                    <div class="mb-3">
                        <label class="form-label">Номер карты</label>
                        <input type="text" class="form-control" id="cardNumber" placeholder="XXXX XXXX XXXX XXXX" maxlength="19" name="card_number" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Дата истечения</label>
                        <input type="text" class="form-control" id="cardDate" placeholder="MM/YY" maxlength="5" name="expiry_date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">CVV</label>
                        <input type="password" class="form-control" id="cardCVV" placeholder="XXX" maxlength="3" name="cvv" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </form>
            </div>

            <!-- Место получения -->
            <div class="mb-3">
                <label class="form-label">Место получения:</label>
                <input type="text" class="form-control" value="ул. Серышева, 88" readonly>
            </div>

            <!-- Получатель -->
            <div class="mb-3">
                <label class="form-label">Получатель:</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="recipient" id="me" value="me" checked>
                    <label class="form-check-label" for="me">Я</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="recipient" id="other" value="other">
                    <label class="form-check-label" for="other">Другой</label>
                </div>
            </div>

            <!-- Pop-up окно для ввода данных другого получателя -->
            <div class="popup-overlay" id="popupOverlay"></div>
            <div class="popup" id="popup">
                <h5>Введите данные получателя</h5>
                <form id="recipientForm">
                    <div class="mb-3">
                        <label class="form-label">Имя</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Почта</label>
                        <input type="email" class="form-control" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Телефон</label>
                        <input type="tel" class="form-control" name="phone" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </form>
            </div>
        </div>

        <!-- Правая часть: кнопка оплаты -->
        <div class="checkout-sidebar">
            <h5>Итого к оплате:</h5>
            <h4 id="totalAmount" style="margin: 0;">{{ summa }}</h4>
            <p>рублей</p>
            <button class="btn btn-success w-100" id="payButton">Оплатить / Создать заказ</button>
        </div>
    </div>


<!-- Контейнер для уведомлений -->
<div id="notification-container"></div>
{% endblock %}

{% block js %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showNotification(type, message) {
            const notificationContainer = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade-in`;
            notification.role = 'alert';
            notification.innerHTML = `
                ${message}
            `;
            notificationContainer.appendChild(notification);

            // Удаляем уведомление через 3 секунды
            setTimeout(() => {
                notification.classList.remove('fade-in'); // Убираем класс для запуска исчезновения
                notification.classList.add('fade-out'); // Добавляем класс для анимации исчезновения

                // Удаляем элемент после завершения анимации
                notification.addEventListener('animationend', () => {
                    notification.remove();
                });
            }, 3000); // 3 секунды
        }
    </script>
    <script src="{% static 'cart/js/order.js' %}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    $(document).ready(function () {
        $('#newCardForm').on('submit', function (e) {
            e.preventDefault(); // Предотвращаем отправку формы

            const formData = {
                card_number: $('#cardNumber').val().replace(/\s+/g, ''), // Убираем пробелы из номера карты
                expiry_date: $('#cardDate').val().replace(/\//g, ''),
                cvv: $('#cardCVV').val()
            };

            console.log("Отправляемые данные:", formData);

            $.ajax({
                url: "{% url 'add_card' %}",
                method: 'POST',
                data: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}' // Защита CSRF
                },
                success: function (response) {
                    console.log("Ответ от сервера:", response);
                    if (response.status === 'success') {
                        showNotification("success", response.message);
                        $('#newCardForm')[0].reset(); // Очищаем форму
                    } else {
                        showNotification("danger", response.message);
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Ошибка AJAX:", status, error);
                    showNotification("danger", 'Произошла ошибка при отправке данных.');
                }
            });
        });
    });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const payButton = document.getElementById('payButton');
            const selectedCardInput = document.getElementById('selectedCard');
            const cvvInput = document.getElementById('cvvInput');
            const paymentMethodSelect = document.getElementById('paymentMethod');
            const recipientForm = document.getElementById('recipientForm');
            const totalAmount = document.getElementById('totalAmount').textContent.trim();

            let recipientData = null; // Данные получателя

            // Слушатель для выбора другого получателя
            document.getElementById('other').addEventListener('change', function () {
                if (this.checked) {
                    document.getElementById('popupOverlay').style.display = 'block';
                    document.getElementById('popup').style.display = 'block';
                }
            });

            // Сохранение данных получателя
            recipientForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(recipientForm);
                recipientData = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    phone: formData.get('phone')
                };
                console.log(recipientData)
                document.getElementById('popupOverlay').style.display = 'none';
                document.getElementById('popup').style.display = 'none';
            });

            // Создание заказа при нажатии на кнопку "Оплатить / Создать заказ"
            payButton.addEventListener('click', function () {
                // Получаем данные об аутентификации из атрибута data-is-authenticated
                const isAuthenticated = document.body.dataset.isAuthenticated == 'true';

                console.log(document.body.dataset.isAuthenticated);

                if (!isAuthenticated) {
                    showNotification("danger" ,'Пользователь не авторизован.');
                    return;
                }

                // Здесь user_id будет получен позже из сессии Django (например, в services.py)
                let user_id = null; // Пока оставляем как null, будем получать на сервере

                const paymentMethod = paymentMethodSelect.value;
                const order_date = new Date().toISOString(); // Текущее время
                const status = paymentMethod === 'card' ? 'Ожидает получения' : 'Ожидает оплаты';
                const total_price = parseFloat(totalAmount.replace(',', '.')); // Преобразуем цену в число

                // Проверка наличия выбранной карты, если способ оплаты - карта
                let card_number = null;
                if (paymentMethod === 'card') {
                    if (!selectedCardInput.value.trim()) {
                        showNotification("danger", 'Выберите карту для оплаты.');
                        return;
                    }
                    card_number = selectedCardInput.value.split(' ')[1]; // Извлекаем последние 4 цифры
                }

                // Формируем комментарий, если указан другой получатель
                const comment = recipientData
                    ? `Получатель: ${recipientData.name}, Телефон: ${recipientData.phone}, Почта: ${recipientData.email}`
                    : '';

                // Отправляем данные на сервер
                fetch('/cart/create-order/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}' // Защита CSRF
                    },
                    body: JSON.stringify({
                        user_id: user_id,
                        order_date: order_date,
                        total_price: total_price,
                        status: status,
                        comment: comment,
                        card_number: card_number,
                        cvv: cvvInput.value,
                        items: '{{ items }}'
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            showNotification("success", 'Заказ успешно создан!');
                            window.location.href = '/cart/'; // Перенаправляем на страницу заказов
                        } else {
                            showNotification("danger", `Ошибка: ${data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка при создании заказа:', error);
                        showNotification("danger", 'Произошла ошибка при создании заказа.');
                    });
            });
        });
    </script>
{% endblock %}